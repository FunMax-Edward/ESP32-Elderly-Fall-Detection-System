<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能老人跌倒监护系统</title>
  <!-- 从国内CDN加载Vue3和Element Plus -->
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.47/vue.global.prod.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.1/index.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.1/index.min.css">
  <!-- 图表库 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- 引入3D库 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- 添加图标库 -->
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #409EFF;
      --accent-color: #F56C6C;
      --success-color: #67C23A;
      --warning-color: #E6A23C;
      --bg-dark: #0A0E1A;
      --bg-card: rgba(24, 29, 49, 0.85);
      --text-primary: #E0E0E0;
      --text-secondary: #AAAAAA;
      --border-radius: 12px;
      
      /* 新增按钮颜色变量 */
      --btn-start-gradient: linear-gradient(135deg, #4776E6, #8E54E9);
      --btn-stop-gradient: linear-gradient(135deg, #FF416C, #FF4B2B);
      --btn-calibrate-gradient: linear-gradient(135deg, #00B09B, #96C93D);
      --btn-emergency-gradient: linear-gradient(135deg, #ED213A, #93291E);
    }
    
    /* 基础样式 */
    body {
      font-family: "PingFang SC", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 80px;
    }
    
    /* 毛玻璃效果卡片 */
    .glass-card {
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    
    .glass-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    }
    
    /* 头部样式 */
    .header {
      padding: 20px 0;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(45deg, var(--primary-color), #61dafb);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    
    /* 数据卡片样式 */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      padding: 24px;
      display: flex;
      flex-direction: column;
    }
    
    .stat-card .title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-card .value {
      font-size: 36px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    /* 跌倒警报样式 */
    .fall-alert {
      border: 1px solid var(--accent-color) !important;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(245, 108, 108, 0.5); }
      70% { box-shadow: 0 0 0 15px rgba(245, 108, 108, 0); }
      100% { box-shadow: 0 0 0 0 rgba(245, 108, 108, 0); }
    }
    
    /* 图表容器 */
    .chart-container {
      width: 100%;
      height: 300px;
      padding: 20px;
      position: relative;
    }
    
    /* 控制按钮 */
    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-bottom: 20px;
    }
    
    .control-btn {
      width: 100%;
      height: 52px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      background: var(--btn-start-gradient);
      color: var(--text-primary);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    }
    
    .control-btn.start {
      background: var(--btn-start-gradient);
    }
    
    .control-btn.stop {
      background: var(--btn-stop-gradient);
    }
    
    .control-btn.calibrate {
      background: var(--btn-calibrate-gradient);
    }
    
    .control-btn.emergency {
      background: var(--btn-emergency-gradient);
    }
    
    /* 加载效果 */
    .loading-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    
    .loading-mask.hide {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(64, 158, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 离线提示 */
    .offline-tip {
      background-color: rgba(230, 162, 60, 0.1);
      color: var(--warning-color);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid rgba(230, 162, 60, 0.2);
      display: none;
    }
    
    .offline-tip.active {
      display: block;
    }
    
    /* 自定义Element Plus样式 */
    .el-tag {
      background-color: transparent !important;
    }
    
    .el-tag--success {
      color: var(--success-color) !important;
      border-color: var(--success-color) !important;
    }
    
    .el-tag--danger {
      color: var(--accent-color) !important;
      border-color: var(--accent-color) !important;
    }
    
    .el-tag--warning {
      color: var(--warning-color) !important;
      border-color: var(--warning-color) !important;
    }
    
    .el-table {
      background-color: transparent !important;
    }
    
    .el-table th {
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: var(--text-secondary) !important;
    }
    
    .el-table td {
      background-color: transparent !important;
      color: var(--text-primary) !important;
      border-bottom-color: rgba(255, 255, 255, 0.05) !important;
    }
    
    .el-table--enable-row-hover .el-table__body tr:hover > td {
      background-color: rgba(255, 255, 255, 0.05) !important;
    }
    
    .el-input__inner, .el-input-group__append {
      background-color: rgba(255, 255, 255, 0.05) !important;
      border-color: rgba(255, 255, 255, 0.1) !important;
      color: var(--text-primary) !important;
    }
    
    .el-button {
      border-radius: 8px !important;
    }
    
    .el-button--primary {
      background: linear-gradient(45deg, var(--primary-color), #61dafb) !important;
      border: none !important;
    }
    
    .el-dialog {
      background: var(--bg-card) !important;
      border-radius: var(--border-radius) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.2) !important;
    }
    
    .el-dialog__title {
      color: var(--text-primary) !important;
    }
    
    .el-form-item__label {
      color: var(--text-secondary) !important;
    }
    
    .el-alert {
      background-color: rgba(245, 108, 108, 0.1) !important;
      color: var(--text-primary) !important;
    }
    
    .el-alert--error {
      border: 1px solid rgba(245, 108, 108, 0.2) !important;
    }
    
    .el-divider__text {
      background-color: var(--bg-card) !important;
      color: var(--text-secondary) !important;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .buttons-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 220px;
      }
      
      .stat-card .value {
        font-size: 28px;
      }
    }
    
    /* 在CSS之后添加图标间距样式 */
    .mr-1 { margin-right: 4px; }
    .mr-2 { margin-right: 8px; }
    
    /* 添加表格深色主题样式 */
    .el-table {
      --el-table-border-color: rgba(255, 255, 255, 0.05) !important;
      --el-table-header-bg-color: rgba(24, 29, 49, 0.85) !important;
      --el-table-row-hover-bg-color: rgba(255, 255, 255, 0.08) !important;
      --el-table-bg-color: transparent !important;
      --el-table-tr-bg-color: transparent !important;
      --el-table-expanded-cell-bg-color: transparent !important;
      --el-fill-color-lighter: rgba(255, 255, 255, 0.02) !important;
      --el-fill-color-light: rgba(255, 255, 255, 0.05) !important;
      box-shadow: none !important;
      background-color: transparent !important;
    }
    
    .el-table .el-table__inner-wrapper {
      background-color: transparent !important;
    }
    
    .el-table::before {
      display: none !important;
    }
    
    .el-table__empty-text {
      color: var(--text-secondary) !important;
    }
    
    .el-table__empty-block {
      background-color: transparent !important;
    }
  </style>
  <!-- 引入本地CSS -->
  <link rel="stylesheet" href="/modern.css">
</head>
<body>
  <!-- 动态背景光源 -->
  <div class="dynamic-bg">
    <div class="light-source"></div>
    <div class="light-source"></div>
    <div class="light-source"></div>
    <div class="light-source"></div>
  </div>
  
  <!-- 粒子背景 -->
  <div class="particle-bg"></div>

  <!-- 加载遮罩 -->
  <div id="loading" class="loading-mask">
    <div class="loading-spinner"></div>
    <p>系统初始化中...</p>
  </div>

  <div id="app">
    <!-- 导航栏 -->
    <nav class="nav-bar">
      <div class="nav-container">
        <h1 class="logo">跌倒监护系统</h1>
        <div class="nav-tabs">
          <div class="nav-tab" :class="{ active: activeTab === 'monitoring' }" @click="activeTab = 'monitoring'">监测</div>
          <div class="nav-tab" :class="{ active: activeTab === 'history' }" @click="activeTab = 'history'">历史</div>
          <div class="nav-tab" :class="{ active: activeTab === 'settings' }" @click="activeTab = 'settings'">设置</div>
        </div>
        <el-tag 
          :type="monitoringActive ? 'success' : 'info'" 
          effect="dark" 
          size="large"
          class="status-tag"
        >
          {{ monitoringActive ? '监测中' : '已暂停' }}
        </el-tag>
      </div>
    </nav>
    
    <div class="main-container">
      <!-- 离线提示 -->
      <div id="offline-tip" class="offline-tip">
        <strong>网络连接已断开</strong>，系统正在尝试重新连接...
        </div>

      <!-- 监测页 -->
      <div v-if="activeTab === 'monitoring'" class="page-container">
        <!-- 页面标题区 -->
        <div class="page-header">
          <h2 class="section-title">实时监测</h2>
          <p class="section-subtitle">监测老人状态，及时响应跌倒事件</p>
        </div>

        <!-- 跌倒警报 -->
        <el-alert
          v-if="fallenState"
          title="检测到跌倒事件！"
          type="error"
          description="系统检测到可能的跌倒，请立即查看老人状态"
          show-icon
          :closable="false"
          class="fall-alert glass-card"
        >
          <template #default>
            <div class="alert-content">
              <p class="alert-info">已持续时间: {{ formatDuration(fallDuration) }}</p>
              <button class="action-button emergency" @click="triggerEmergency">
                <i class="fas fa-phone-alt mr-2"></i> 紧急呼叫
              </button>
            </div>
          </template>
        </el-alert>
        
        <!-- 信息卡片区 -->
        <div class="card-grid">
          <!-- 传感器数据卡片 -->
          <div class="glass-card feature-card" :class="{ 'fall-alert': fallenState }">
            <div class="card-header">
              <h3>实时姿态角度</h3>
              <div class="sensor-refresh-time">更新: {{ new Date().toLocaleTimeString() }}</div>
            </div>
            
            <!-- 新的姿态可视化区域 -->
            <div class="sensor-container">
              <!-- 3D设备可视化 -->
              <div class="device-model-container">
                <div class="device-model" :style="{
                  transform: `rotateX(${-pitch}deg) rotateY(0deg) rotateZ(${roll}deg)`
                }">
                  <div class="device-face front">
                    <span>MPU6050</span>
                    <span class="axis-label z-axis">Z</span>
                  </div>
                  <div class="device-face back">
                    <span class="axis-label z-axis">-Z</span>
                  </div>
                  <div class="device-face top">
                    <span class="axis-label y-axis">Y</span>
                  </div>
                  <div class="device-face bottom">
                    <span class="axis-label y-axis">-Y</span>
                  </div>
                  <div class="device-face left">
                    <span class="axis-label x-axis">-X</span>
                  </div>
                  <div class="device-face right">
                    <span class="axis-label x-axis">X</span>
                  </div>
                </div>
                <div class="device-shadow"></div>
              </div>
              
              <!-- 角度可视化 -->
              <div class="angle-visualizer">
                <div class="angle-container" style="margin-bottom: 30px;">
                  <div class="angle-title">俯仰角</div>
                  <div class="angle-chart">
                    <div class="angle-value" :class="getAngleClass(pitch)">
                      {{ pitch.toFixed(1) }}°
                    </div>
                    <div class="angle-line">
                      <div class="angle-path" :class="getAngleClass(pitch)"></div>
                      <svg class="angle-path-line" viewBox="0 0 400 100" preserveAspectRatio="none">
                        <path :d="pitchPath" />
                      </svg>
                    </div>
                    <div class="angle-grid">
                      <div class="angle-grid-line"></div>
                      <div class="angle-grid-line"></div>
                      <div class="angle-grid-line"></div>
                      <div class="angle-grid-line"></div>
                    </div>
                    <div class="angle-grid-labels">
                      <div class="angle-grid-label">45°</div>
                      <div class="angle-grid-label">30°</div>
                      <div class="angle-grid-label">15°</div>
                      <div class="angle-grid-label">0°</div>
                    </div>
                  </div>
                </div>
                
                <div class="angle-container">
                  <div class="angle-title">横滚角</div>
                  <div class="angle-chart">
                    <div class="angle-value roll" :class="getAngleClass(roll)">
                      {{ roll.toFixed(1) }}°
                    </div>
                    <div class="angle-line">
                      <div class="angle-path roll" :class="getAngleClass(roll)"></div>
                      <svg class="angle-path-line roll" viewBox="0 0 400 100" preserveAspectRatio="none">
                        <path :d="rollPath" />
                      </svg>
                    </div>
                    <div class="angle-grid">
                      <div class="angle-grid-line"></div>
                      <div class="angle-grid-line"></div>
                      <div class="angle-grid-line"></div>
                      <div class="angle-grid-line"></div>
                    </div>
                    <div class="angle-grid-labels">
                      <div class="angle-grid-label">45°</div>
                      <div class="angle-grid-label">30°</div>
                      <div class="angle-grid-label">15°</div>
                      <div class="angle-grid-label">0°</div>
                    </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 系统状态卡片 -->
          <div class="glass-card feature-card">
            <div class="card-header">
              <h3>系统控制</h3>
            </div>
            <div class="control-buttons">
              <button 
                class="action-button large-button"
                :class="monitoringActive ? 'stop' : 'start'"
                @click="toggleMonitoring"
              >
                <i :class="monitoringActive ? 'fas fa-pause-circle' : 'fas fa-play-circle'" class="mr-2"></i>
                {{ monitoringActive ? '暂停监测' : '开始监测' }}
              </button>
              <button class="action-button large-button calibrate" @click="calibrate">
                <i class="fas fa-sync-alt mr-2"></i> 校准传感器
              </button>
              <button class="action-button large-button emergency" @click="triggerEmergency">
                <i class="fas fa-phone-alt mr-2"></i> 紧急呼叫
              </button>
            </div>

            <!-- 语音控制区域 -->
            <div class="voice-control">
              <h4 class="section-subtitle">语音指令</h4>
              <div class="voice-input">
                <el-input
                  v-model="voiceCommand"
                  placeholder="输入语音指令（如：开启监测、关闭监测）"
                  clearable
                >
                  <template #append>
                    <el-button @click="sendVoiceCommand">
                      发送
                    </el-button>
                  </template>
                </el-input>
                    </div>
              <div class="last-command">
                <span class="command-label">最近命令:</span>
                <el-tag size="small" effect="plain" v-if="lastCommand">{{ lastCommand }}</el-tag>
                    </div>
                    </div>
                </div>
            </div>

        <!-- 系统信息卡片 -->
        <div class="glass-card info-card">
          <div class="card-header">
            <h3>系统信息</h3>
          </div>
          <div class="system-info-grid">
            <div class="info-item">
              <div class="info-label">WiFi状态</div>
              <div class="info-value">{{ wifiStatus }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">运行时间</div>
              <div class="info-value">{{ formatDuration(uptime) }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">最近校准</div>
              <div class="info-value">{{ lastCalibration }}</div>
            </div>
            <div class="info-item">
              <button class="action-button small-button" @click="showWiFiDialog = true">
                <i class="fas fa-wifi mr-2"></i> WiFi配置
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 历史页 -->
      <div v-if="activeTab === 'history'" class="page-container">
        <div class="page-header">
          <h2 class="section-title">历史记录</h2>
          <p class="section-subtitle">查看历史跌倒事件和系统状态变化</p>
        </div>
        
        <!-- 历史记录表格 -->
        <div class="glass-card">
          <div class="card-header">
            <h3>跌倒历史记录</h3>
            <div class="card-actions">
              <button class="action-button small-button" @click="clearHistory" v-if="fallHistory.length > 0">
                <i class="fas fa-trash-alt mr-2"></i> 清空记录
              </button>
            </div>
          </div>
          <el-table
            :data="fallHistory"
            style="width: 100%"
            max-height="500"
            :empty-text="'暂无历史记录'"
            class="custom-table"
          >
            <el-table-column prop="time" label="时间" width="180">
              <template #default="scope">
                {{ formatTime(scope.row.time) }}
              </template>
            </el-table-column>
            <el-table-column prop="type" label="类型" width="120">
              <template #default="scope">
                <el-tag 
                  :type="scope.row.type.includes('紧急') ? 'danger' : 'warning'"
                  effect="dark"
                >
                  {{ scope.row.type }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="duration" label="持续时间">
              <template #default="scope">
                {{ scope.row.duration ? scope.row.duration + '秒' : '立即处理' }}
              </template>
            </el-table-column>
            <el-table-column label="操作" width="120">
              <template #default="scope">
                <button class="action-button mini-button" @click="viewHistoryDetail(scope.row)">
                  <i class="fas fa-info-circle mr-1"></i> 查看详情
                </button>
              </template>
            </el-table-column>
          </el-table>
        </div>
        
        <!-- 历史统计卡片 -->
        <div class="card-grid small-grid">
          <div class="glass-card stat-card">
            <div class="stat-value">{{ fallHistory.length }}</div>
            <div class="stat-label">总事件数</div>
          </div>
          <div class="glass-card stat-card">
            <div class="stat-value">{{ getEmergencyCount() }}</div>
            <div class="stat-label">紧急事件</div>
          </div>
          <div class="glass-card stat-card">
            <div class="stat-value">{{ getLastWeekCount() }}</div>
            <div class="stat-label">本周事件</div>
          </div>
        </div>
            </div>

      <!-- 设置页 -->
      <div v-if="activeTab === 'settings'" class="page-container">
        <div class="page-header">
          <h2 class="section-title">系统设置</h2>
          <p class="section-subtitle">配置系统参数和通知选项</p>
                    </div>
        
        <!-- 设置选项卡片 -->
        <div class="glass-card">
          <div class="card-header">
            <h3>基本设置</h3>
                    </div>
          <div class="settings-form">
            <div class="setting-item">
              <div class="setting-label">自动启动监测</div>
              <el-switch v-model="settings.autoStart"></el-switch>
                </div>
            <div class="setting-item">
              <div class="setting-label">推送通知</div>
              <el-switch v-model="settings.notifications"></el-switch>
            </div>
            <div class="setting-item">
              <div class="setting-label">数据存储天数</div>
              <el-select v-model="settings.dataDays" placeholder="选择天数">
                <el-option label="7天" value="7"></el-option>
                <el-option label="30天" value="30"></el-option>
                <el-option label="90天" value="90"></el-option>
                <el-option label="永久" value="-1"></el-option>
              </el-select>
                </div>
            <div class="setting-item">
              <div class="setting-label">敏感度调整</div>
              <el-slider v-model="settings.sensitivity" :min="1" :max="10" :step="1"></el-slider>
                </div>
            <div class="action-row">
              <button class="action-button" @click="saveSettings">
                <i class="fas fa-save mr-2"></i> 保存设置
              </button>
            </div>
        </div>
    </div>

        <!-- 关于系统 -->
        <div class="glass-card">
          <div class="card-header">
            <h3>关于系统</h3>
          </div>
          <div class="about-system">
            <p>智能老人跌倒监护系统 v1.0</p>
            <p>基于ESP32和MPU6050的物联网监护系统</p>
            <p>Copyright © 2023 All Rights Reserved</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- WiFi配置对话框 -->
    <el-dialog
      title="WiFi配置"
      v-model="showWiFiDialog"
      width="80%"
      :append-to-body="true"
      class="custom-dialog"
    >
      <el-form :model="wifiForm" label-width="100px">
        <el-form-item label="WiFi名称">
          <el-input v-model="wifiForm.ssid" placeholder="请输入WiFi名称"></el-input>
        </el-form-item>
        <el-form-item label="WiFi密码">
          <el-input v-model="wifiForm.password" type="password" placeholder="请输入WiFi密码" show-password></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <button class="action-button cancel" @click="showWiFiDialog = false">
            <i class="fas fa-times mr-2"></i> 取消
          </button>
          <button class="action-button" @click="saveWiFiConfig">
            <i class="fas fa-check mr-2"></i> 保存并连接
          </button>
        </span>
      </template>
    </el-dialog>
    
    <!-- 历史详情对话框 -->
    <el-dialog
      title="事件详情"
      v-model="showHistoryDialog"
      width="80%"
      :append-to-body="true"
      class="custom-dialog"
    >
      <div v-if="selectedHistory">
        <div class="history-detail-grid">
          <div class="detail-item">
            <div class="detail-label">发生时间</div>
            <div class="detail-value">{{ formatTime(selectedHistory.time) }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">事件类型</div>
            <div class="detail-value">
              <el-tag 
                :type="selectedHistory.type.includes('紧急') ? 'danger' : 'warning'"
                effect="dark"
              >
                {{ selectedHistory.type }}
              </el-tag>
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">持续时间</div>
            <div class="detail-value">{{ selectedHistory.duration ? selectedHistory.duration + '秒' : '立即处理' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">俯仰角</div>
            <div class="detail-value">{{ selectedHistory.pitch ? selectedHistory.pitch.toFixed(1) + '°' : '未记录' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">横滚角</div>
            <div class="detail-value">{{ selectedHistory.roll ? selectedHistory.roll.toFixed(1) + '°' : '未记录' }}</div>
          </div>
        </div>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <button class="action-button" @click="showHistoryDialog = false">
            <i class="fas fa-times mr-2"></i> 关闭
          </button>
        </span>
      </template>
    </el-dialog>
    </div>

    <script>
    window.addEventListener('load', function() {
      // 2秒后隐藏加载遮罩
      setTimeout(function() {
        document.getElementById('loading').classList.add('hide');
      }, 2000);
      
      // 注册Service Worker实现离线缓存
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
          console.log('ServiceWorker 注册成功:', registration.scope);
        }).catch(function(error) {
          console.log('ServiceWorker 注册失败:', error);
        });
      }
    });
    
    const { createApp, ref, reactive, onMounted, onBeforeUnmount, computed, watch } = Vue;

    const app = createApp({
      setup() {
        // 状态变量
        const pitch = ref(0);
        const roll = ref(0);
        const fallenState = ref(false);
        const fallDuration = ref(0);
        const monitoringActive = ref(true);
        const fallHistory = ref([]);
        const voiceCommand = ref('');
        const lastCommand = ref('');
        const wifiStatus = ref('已连接');
        const uptime = ref(0);
        const lastCalibration = ref('未校准');
        const isOffline = ref(false);
        const activeTab = ref('monitoring');
        
        // 角度历史数据队列
        const pitchHistory = ref([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
        const rollHistory = ref([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
        
        // 折线图路径
        const pitchPath = ref('');
        const rollPath = ref('');

        // 设置相关状态
        const settings = reactive({
          autoStart: true,
          notifications: true,
          dataDays: "30",
          sensitivity: 7
        });
        
        // 添加WiFi配置相关状态
        const showWiFiDialog = ref(false);
        const wifiForm = reactive({
          ssid: '',
          password: ''
        });
        
        // 历史记录详情相关状态
        const showHistoryDialog = ref(false);
        const selectedHistory = ref(null);
        
        // WebSocket连接
        let ws = null;
        let reconnectCount = 0;
        const maxReconnectAttempts = 10;
        let reconnectTimer = null;
        
        // 更新折线图路径
        const updatePaths = () => {
          // 更新俯仰角路径 - 更平滑的曲线
          let pPoints = '';
          
          // 使用更多的点来创建更平滑的曲线
          const smoothPoints = [];
          
          // 首先创建一个平滑的数据集
          for (let i = 0; i < 12; i++) {
            // 限制角度范围在 -45 到 45 度
            const value = Math.min(Math.max(pitchHistory.value[i], -45), 45);
            // 角度值越大，y值越小
            smoothPoints.push(50 - (value / 45 * 40));
          }
          
          // 使用平滑点创建路径，移动到第一个点
          pPoints = `M0,${smoothPoints[0]}`;
          
          // 对中间点使用三次贝塞尔曲线创建平滑线条
          for (let i = 0; i < smoothPoints.length - 1; i++) {
            const x1 = i * (400 / 11);
            const x2 = (i + 1) * (400 / 11);
            const y1 = smoothPoints[i];
            const y2 = smoothPoints[i + 1];
            
            // 使用简单的曲线连接
            pPoints += ` L${x2},${y2}`;
          }
          
          pitchPath.value = pPoints;
          
          // 更新横滚角路径 - 类似处理
          let rPoints = '';
          const smoothRollPoints = [];
          
          for (let i = 0; i < 12; i++) {
            const value = Math.min(Math.max(rollHistory.value[i], -45), 45);
            smoothRollPoints.push(50 - (value / 45 * 40));
          }
          
          rPoints = `M0,${smoothRollPoints[0]}`;
          
          for (let i = 0; i < smoothRollPoints.length - 1; i++) {
            const x1 = i * (400 / 11);
            const x2 = (i + 1) * (400 / 11);
            const y1 = smoothRollPoints[i];
            const y2 = smoothRollPoints[i + 1];
            
            rPoints += ` L${x2},${y2}`;
          }
          
          rollPath.value = rPoints;
        };
        
        // 监听角度变化并更新历史数据
        watch(pitch, (newValue) => {
          pitchHistory.value.push(newValue);
          pitchHistory.value.shift();
          updatePaths();
        });
        
        watch(roll, (newValue) => {
          rollHistory.value.push(newValue);
          rollHistory.value.shift();
          updatePaths();
        });

        // 方法
        const toggleMonitoring = () => {
          const newState = !monitoringActive.value;
          sendWebSocketMessage({
            action: 'set_monitoring',
            value: newState
          });
          monitoringActive.value = newState;
        };

        const calibrate = () => {
          sendWebSocketMessage({
            action: 'calibrate'
          });
          showMessage('success', '传感器校准命令已发送');
        };

        const triggerEmergency = () => {
          sendWebSocketMessage({
            action: 'emergency'
          });
          showMessage('warning', '紧急呼叫已触发');
        };

        const sendVoiceCommand = () => {
          if (!voiceCommand.value) return;
          
          sendWebSocketMessage({
            action: 'voice_command',
            value: voiceCommand.value
          });
          
          showMessage('info', `语音命令已发送: ${voiceCommand.value}`);
          lastCommand.value = voiceCommand.value;
          voiceCommand.value = '';
        };
        
        // 保存WiFi配置
        const saveWiFiConfig = () => {
          if (!wifiForm.ssid) {
            showMessage('error', 'WiFi名称不能为空');
            return;
          }
          
          sendWebSocketMessage({
            action: 'set_wifi_config',
            ssid: wifiForm.ssid,
            password: wifiForm.password
          });
          
          showMessage('success', 'WiFi配置已发送，设备将尝试连接到新网络');
          showWiFiDialog.value = false;
        };
        
        // 保存系统设置
        const saveSettings = () => {
          sendWebSocketMessage({
            action: 'save_settings',
            settings: settings
          });
          
          showMessage('success', '设置已保存');
        };
        
        // 查看历史记录详情
        const viewHistoryDetail = (item) => {
          selectedHistory.value = item;
          showHistoryDialog.value = true;
        };
        
        // 清空历史记录
        const clearHistory = () => {
          ElMessageBox.confirm('确定要清空所有历史记录吗？', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            sendWebSocketMessage({
              action: 'clear_history'
            });
            fallHistory.value = [];
            showMessage('success', '历史记录已清空');
          }).catch(() => {});
        };
        
        // 获取紧急事件数量
        const getEmergencyCount = () => {
          return fallHistory.value.filter(item => item.type.includes('紧急')).length;
        };
        
        // 获取本周事件数量
        const getLastWeekCount = () => {
          const oneWeekAgo = new Date();
          oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
          return fallHistory.value.filter(item => new Date(item.time) >= oneWeekAgo).length;
        };
        
        // 获取角度状态类
        const getAngleClass = (angle) => {
          const value = Math.abs(angle);
          if (value > 45) return 'danger';
          if (value > 30) return 'warning';
          return 'normal';
        };
        
        // 安全地发送WebSocket消息
        const sendWebSocketMessage = (message) => {
          try {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify(message));
              return true;
            } else {
              showMessage('error', '连接已断开，无法发送命令');
              setOfflineStatus(true);
              reconnectWebSocket();
              return false;
            }
          } catch (e) {
            console.error('发送消息错误:', e);
            return false;
          }
        };
        
        // 设置离线状态
        const setOfflineStatus = (status) => {
          isOffline.value = status;
          const offlineTip = document.getElementById('offline-tip');
          if (offlineTip) {
            if (status) {
              offlineTip.classList.add('active');
            } else {
              offlineTip.classList.remove('active');
            }
          }
        };
        
        // 显示消息
        const showMessage = (type, message) => {
          if (window.ELEMENT) {
            window.ELEMENT.Message({
              message: message,
              type: type,
              duration: 3000
            });
          } else {
            alert(message);
          }
        };

        const formatTime = (timestamp) => {
          if (!timestamp) return '未知时间';
          const date = new Date(timestamp);
          return date.toLocaleString();
        };

        const formatDuration = (ms) => {
          if (!ms) return '0秒';
          
          const seconds = Math.floor(ms / 1000);
          if (seconds < 60) return `${seconds}秒`;
          
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;
          return `${minutes}分${remainingSeconds}秒`;
        };
        
        // 重连WebSocket
        const reconnectWebSocket = () => {
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
          }
          
          if (reconnectCount < maxReconnectAttempts) {
            const delay = Math.min(1000 * Math.pow(2, reconnectCount), 30000);
            console.log(`尝试重连 (${reconnectCount + 1}/${maxReconnectAttempts})，等待 ${delay}ms...`);
            
            reconnectTimer = setTimeout(() => {
              reconnectCount++;
              connectWebSocket();
            }, delay);
          } else {
            console.error('重连次数过多，请手动刷新页面');
            showMessage('error', '连接失败，请检查设备状态或刷新页面');
          }
        };

        // 连接WebSocket
        const connectWebSocket = () => {
          try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('正在连接WebSocket...', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
              console.log('WebSocket连接已建立');
              showMessage('success', '已连接到跌倒监测系统');
              setOfflineStatus(false);
              reconnectCount = 0; // 重置重连计数器
            };
            
            ws.onclose = (event) => {
              console.log('WebSocket连接已断开', event);
              
              if (!isOffline.value) {
                showMessage('error', '与系统的连接已断开，正在尝试重连...');
                setOfflineStatus(true);
              }
              
              reconnectWebSocket();
            };
            
            ws.onerror = (error) => {
              console.error('WebSocket错误:', error);
              setOfflineStatus(true);
            };
            
            ws.onmessage = (event) => {
              try {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                  case 'angles':
                    pitch.value = data.pitch;
                    roll.value = data.roll;
                    break;
                    
                  case 'fallen_state':
                    fallenState.value = data.fallen;
                    fallDuration.value = data.duration * 1000; // 转换为毫秒
                    break;
                    
                  case 'monitoring':
                    monitoringActive.value = data.active;
                    break;
                    
                  case 'status':
                    showMessage(
                      data.value.includes('警告') ? 'warning' : 'info',
                      data.value
                    );
                    break;
                    
                  case 'command':
                    lastCommand.value = data.value;
                    break;
                    
                  case 'fall_history':
                    fallHistory.value = data.events;
                    break;
                    
                  case 'system_info':
                    wifiStatus.value = data.wifi_status;
                    uptime.value = data.uptime * 1000; // 转换为毫秒
                    lastCalibration.value = data.last_calibration || '未校准';
                    break;
                    
                  case 'wifi_config_result':
                    showMessage(
                      data.success ? 'success' : 'error',
                      data.message
                    );
                    break;
                  
                  case 'settings':
                    if (data.settings) {
                      Object.assign(settings, data.settings);
                    }
                    break;
                    
                  default:
                    console.log('未知消息类型:', data);
                }
              } catch (e) {
                console.error('解析WebSocket消息错误:', e);
              }
            };
          } catch (e) {
            console.error('WebSocket连接错误:', e);
            setOfflineStatus(true);
            reconnectWebSocket();
          }
        };

        // 生命周期钩子
        onMounted(() => {
          // 初始化路径
          updatePaths();

          // 添加网络状态监听
          window.addEventListener('online', () => {
            console.log('网络已恢复');
            setOfflineStatus(false);
            reconnectWebSocket();
          });
          
          window.addEventListener('offline', () => {
            console.log('网络已断开');
            setOfflineStatus(true);
          });
          
          // 延迟初始化，确保DOM已加载
          setTimeout(() => {
            try {
              connectWebSocket();
              
              // 每秒更新一次时间
              const timer = setInterval(() => {
                if (fallenState.value) {
                  fallDuration.value += 1000;
                }
              }, 1000);
              
              onBeforeUnmount(() => {
                clearInterval(timer);
                if (ws) {
                  ws.close();
                }
                if (reconnectTimer) {
                  clearTimeout(reconnectTimer);
                }
              });
            } catch (e) {
              console.error('初始化错误:', e);
              showMessage('error', '系统初始化失败，请刷新页面重试');
            }
          }, 500);
        });

        return {
          // 状态
          pitch,
          roll,
          fallenState,
          fallDuration,
          monitoringActive,
          fallHistory,
          voiceCommand,
          lastCommand,
          wifiStatus,
          uptime,
          lastCalibration,
          isOffline,
          activeTab,
          settings,
          
          // 图表相关
          pitchPath,
          rollPath,
          
          // WiFi配置相关属性
          showWiFiDialog,
          wifiForm,
          
          // 历史记录详情相关属性
          showHistoryDialog,
          selectedHistory,
          
          // 方法
          toggleMonitoring,
          calibrate,
          triggerEmergency,
          sendVoiceCommand,
          saveWiFiConfig,
          saveSettings,
          viewHistoryDetail,
          clearHistory,
          getEmergencyCount,
          getLastWeekCount,
          getAngleClass,
          formatTime,
          formatDuration
        };
      }
    });

    // 挂载应用
    app.use(ElementPlus);
    app.mount('#app');
    </script>
</body>
</html>
